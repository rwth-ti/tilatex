\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tiref}[2014/10/22 v0.1]

\RequirePackage{tiinternal}
\usepackage[colorlinks=true]{hyperref}
\usepackage{ifthen}
\usepackage{xstring}
\usepackage{xparse}

% Utility commands
\newcommand*{\tiref@ifempty}[3]{\ifthenelse{\equal{#1}{}}{#2}{#3}}

% Macro to define reference names. This allows linking prefixes like `prop:`
% in label names like `prop:foo` to string expansions like `Proposition`.
\newcommand{\definereftype}[2]{%
    \expandafter\newcommand\csname tiref@refname#1\endcsname{#2}%
}

\newcommand{\rawtiref}[1]{%
    \StrCut{#1}{/}{\tiref@basename}{\tiref@itemname}%
    \tiref@ifempty{\tiref@itemname}{%
        \ref{#1}%
    }{%
        % Use the starred version of \ref in the second argument to `hyperref`
        % so the package doesn't create links to both the basename and the
        % actual target.
        \hyperref[#1]{\ref*{\tiref@basename}\ref*{#1}}%
    }%
}

\DeclareDocumentCommand{\tiref}{o m}{%
    \IfNoValueTF{#1}{%
        \StrCut{#2}{:}{\tiref@domain}{\tiref@refname}%
        \tiref@ifempty{\tiref@refname}{}{%
            \ifcsname tiref@refname\tiref@domain\endcsname%
                \csname tiref@refname\tiref@domain\endcsname%
            \else%
                \textbf{??}%
            \fi~%
        }%
    }{%
        #1~%
    }%
    \rawtiref{#2}%
}

\endinput

