\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tiexercise}[2014/10/22 v0.1]

\usepackage{tiinternal}
\usepackage{timath}

% Define placeholder values for lecture, lecturer, etc. We assume the lecture
% is given in German by default.
\def\tiexercise@lecture{Vorlesung}
\def\tiexercise@lecturer{Dozent}
\def\tiexercise@supervisor{Betreuer}
\def\tiexercise@date{tt.mm.jjjj}

% Define default text labels.
\def\tiexercise@exerciselabel{Übung}
\def\tiexercise@additionalexerciselabel{Zusatzübung}
\def\tiexercise@proposedsolutionlabel{Lösungsvorschlag}
\def\tiexercise@problemlabel{Aufgabe}
\def\tiexercise@solutionlabel{Lösung zu Aufgabe}

\def\tiexercise@titleprefix{%
    \thetiexercise@ExerciseCounter.\ \tiexercise@exerciselabel%
}

% Handle package options
\DeclareOption{english}{
    \def\tiexercise@lecture{tiexercise@lecture}
    \def\tiexercise@lecturer{tiexercise@lecturer}
    \def\tiexercise@supervisor{tiexercise@supervisor}
    \def\tiexercise@date{dd.mm.yyyy}

    \def\tiexercise@exerciselabel{Exercise}
    \def\tiexercise@additionalexerciselabel{Additional Exercise}
    \def\tiexercise@proposedsolutionlabel{Proposed Solution}
    \def\tiexercise@problemlabel{Problem}
    \def\tiexercise@solutionlabel{Solution of Problem}

    \def\tiexercise@titleprefix{%
        \tiexercise@exerciselabel\ \thetiexercise@ExerciseCounter%
    }
}

\ProcessOptions\relax

% TODO: Move this to the tiexercise class.
% Page layout
\setlength{\textheight}{25.5truecm}
\setlength{\textwidth}{16.2truecm}
\hoffset=-1cm
\voffset=-2cm
\pagestyle{empty}
\parindent=0pt
\parskip=5pt

% Initialize defaults.
% TODO: Rename these.
\def\tiexercise@basepath{.}
\newcommand{\SolutionSuffix}{-solution}

% Define the exercise, problem and solution counters. Note that the exercise
% counter is only defined for convenience of error checking. It's never
% actually incremented, but set manually for each exercise.
\newcounter{tiexercise@ExerciseCounter}
\newcounter{tiexercise@ProblemCounter}[section]
\newcounter{tiexercise@SolutionCounter}[section]

% Define the labelling scheme for enumerate items.
\renewcommand{\labelenumi}{{\textbf{\alph{enumi})}}}
\renewcommand{\labelenumii}{\textbf{\roman{enumii})}}

% Define new environments.
\newenvironment{problem}{
    \stepcounter{tiexercise@ProblemCounter}
    \textsf{%
        \pagebreak[3]%
        \textbf{\tiexercise@problemlabel\ \thetiexercise@ProblemCounter.}%
    }
}{
    \vspace*{1cm}
}
\newenvironment{solution}{
    \stepcounter{tiexercise@SolutionCounter}
    \textsf{%
        \pagebreak[3]%
        \textbf{\large{\tiexercise@solutionlabel\ \thetiexercise@SolutionCounter}}%
    } \\[2mm]
}{
    \vspace*{1cm}
}

% Define commands to set lecture, lecturer, etc.
\newcommand{\setlecture}[1]{\def\tiexercise@lecture{#1}}
\newcommand{\setlecturer}[1]{\def\tiexercise@lecturer{#1}}
\newcommand{\setsupervisor}[1]{\def\tiexercise@supervisor{#1}}
\newcommand{\setexercisenumber}[1]{\setcounter{tiexercise@ExerciseCounter}{#1}}
\newcommand{\setexercisedate}[1]{\def\tiexercise@date{#1}}

% Our counters are zero-based now and incremented before they're used. Hence
% the #1-1 in the commands below.
\newcommand{\setfirstproblem}[1][1]{\setcounter{tiexercise@ProblemCounter}{#1-1}}
\newcommand{\setfirstsolution}[1][1]{\setcounter{tiexercise@SolutionCounter}{#1-1}}

\newcommand{\setbasepath}[1]{\def\tiexercise@basepath{#1}}
\newcommand{\setsolutionsuffix}[1]{\def\SolutionSuffix{#1}}

% Define the document headers.
\def\tiexercise@exerciseheader{
    \begin{center}
        \LARGE \tiexercise@titleprefix\ \tiexercise@lecture \\
        \normalsize \tiexercise@lecturer, \tiexercise@supervisor \\
        \tiexercise@date
    \end{center}
    \vspace{0.5cm}
}
\def\tiexercise@additionalexerciseheader{
    \begin{center}
        \LARGE \tiexercise@additionalexerciselabel\ \tiexercise@lecture \\
        \normalsize \tiexercise@lecturer, \tiexercise@supervisor \\
        \tiexercise@date
    \end{center}
    \vspace{0.5cm}
}
\def\tiexercise@solutionheader{
    \begin{center}
        \LARGE \tiexercise@titleprefix\ \tiexercise@lecture \\
        - \tiexercise@proposedsolutionlabel\ - \\[2mm]
        \normalsize \tiexercise@lecturer, \tiexercise@supervisor \\
        \tiexercise@date
    \end{center}
    \vspace{0.5cm}
}

\newcommand{\insertexerciseheader}{
    \TIHeader
    \tiexercise@exerciseheader
}
\newcommand{\insertadditionalexerciseheader}{
    \TIHeader
    \tiexercise@additionalexerciseheader
}
\newcommand{\insertsolutionheader}{
    \TIHeader
    \tiexercise@solutionheader
}

\newcommand{\insertproblem}[2]{
    \def\ExercisePath{\tiexercise@basepath/section#1/#2.tex}
    \begin{problem}
        \IfFileExists{\ExercisePath}{
                \subimport{\tiexercise@basepath/section#1/}{#2.tex}
        }{
            \begin{center}
                \textbf{-- \ExercisePath\ not found --}
            \end{center}
        }
    \end{problem}
    \par
}
\newcommand{\insertsolution}[2]{
    \def\tiexercise@solutionpath{\tiexercise@basepath/section#1/#2\SolutionSuffix.tex}
    \begin{solution}
        \IfFileExists{\tiexercise@solutionpath}{
            \subimport{\tiexercise@basepath/section#1/}{#2\SolutionSuffix.tex}
        }{
            \begin{center}
                \textbf{-- \tiexercise@solutionpath\ not found --}
            \end{center}
        }
    \end{solution}
    \par
}

% Insert a problem and its solution if available. Only use this for the
% exercise collection documents.
\newcommand{\insertproblemandsolution}[2]{
    \def\ExercisePath{\tiexercise@basepath/section#1/#2.tex}
    \def\tiexercise@solutionpath{\tiexercise@basepath/section#1/#2\SolutionSuffix.tex}
    \IfFileExists{\ExercisePath}{
        \textit{{\ExercisePath}:} \\
        \insertproblem{#1}{#2}
        \textit{{\tiexercise@solutionpath}:} \\
        \insertsolution{#1}{#2}
    }{
        \begin{center}
            \textbf{-- \ExercisePath\ not found --}
        \end{center}
    }
    \vspace{-1cm}%
    \noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}%
    \vspace{1cm}
}

\endinput

