\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tiproblem}[2014/10/22 v0.1]

\usepackage{tiinternal}
\usepackage{tienv}
\usepackage{timath}

% Define placeholder values for lecture, lecturer, etc. We assume the lecture
% is given in German by default.
\def\tiproblem@lecture{Vorlesung}
\def\tiproblem@lecturer{Dozent}
\def\tiproblem@supervisor{Betreuer}
\def\tiproblem@day{dd}
\def\tiproblem@month{mm}
\def\tiproblem@year{yyyy}

\def\tiproblem@formatdate{%
    \tiproblem@day.\tiproblem@month.\tiproblem@year%
}

% Define default text labels.
\def\tiproblem@exerciselabel{Übung}
\def\tiproblem@additionalexerciselabel{Zusatzübung}
\def\tiproblem@proposedsolutionlabel{Lösungsvorschlag}
\def\tiproblem@problemlabel{Aufgabe}
\def\tiproblem@solutionlabel{Lösung zu Aufgabe}

\def\tiproblem@titleprefix{%
    \thetiproblem@ExerciseCounter.\ \tiproblem@exerciselabel%
}

% Handle package options
\DeclareOption{english}{
    \def\tiproblem@lecture{tiproblem@lecture}
    \def\tiproblem@lecturer{tiproblem@lecturer}
    \def\tiproblem@supervisor{tiproblem@supervisor}

    \def\tiproblem@exerciselabel{Exercise}
    \def\tiproblem@additionalexerciselabel{Additional Exercise}
    \def\tiproblem@proposedsolutionlabel{Proposed Solution}
    \def\tiproblem@problemlabel{Problem}
    \def\tiproblem@solutionlabel{Solution of Problem}

    \def\tiproblem@titleprefix{%
        \tiproblem@exerciselabel\ \thetiproblem@ExerciseCounter%
    }

    \def\tiproblem@formatdate{%
        \tiproblem@year-\tiproblem@month-\tiproblem@day%
    }
}

\ProcessOptions\relax

% Initialize defaults.
\def\tiproblem@basepath{.}
\def\tiproblem@solutionsuffix{-solution}

% Define the exercise, problem and solution counters. Note that the exercise
% counter is only defined for convenience of error checking. It's never
% actually incremented, but set manually for each exercise.
\newcounter{tiproblem@ExerciseCounter}
\newcounter{tiproblem@ProblemCounter}[section]
\newcounter{tiproblem@SolutionCounter}[section]

% XXX: These shouldn't be used anymore. Use environments from tienv instead.
% Define the labelling scheme for enumerate items.
\renewcommand{\labelenumi}{{\textbf{\alph{enumi})}}}
\renewcommand{\labelenumii}{\textbf{\roman{enumii})}}

% Define new environments.
\newenvironment{problem}{
    \stepcounter{tiproblem@ProblemCounter}
    \textsf{%
        \pagebreak[3]%
        \textbf{\tiproblem@problemlabel\ \thetiproblem@ProblemCounter.}%
    }
}{
    \vspace*{1cm}
}
\newenvironment{solution}{
    \stepcounter{tiproblem@SolutionCounter}
    \textsf{%
        \pagebreak[3]%
        \textbf{%
            \large{\tiproblem@solutionlabel\ \thetiproblem@SolutionCounter}%
        }%
    } \\[2mm]
}{
    \vspace*{1cm}
}

% Define commands to set lecture, lecturer, etc.
\newcommand{\setlecture}[1]{\def\tiproblem@lecture{#1}}
\newcommand{\setlecturer}[1]{\def\tiproblem@lecturer{#1}}
\newcommand{\setsupervisor}[1]{\def\tiproblem@supervisor{#1}}
\newcommand{\setexercisenumber}[1]{\setcounter{tiproblem@ExerciseCounter}{#1}}
\newcommand{\setexercisedate}[3]{
    \def\tiproblem@day{#1}
    \def\tiproblem@month{#2}
    \def\tiproblem@year{#3}
}

% Our counters are zero-based now and incremented before they're used. Hence
% the #1-1 in the commands below.
\newcommand{\setfirstproblem}[1][1]{%
    \setcounter{tiproblem@ProblemCounter}{#1-1}%
}
\newcommand{\setfirstsolution}[1][1]{%
    \setcounter{tiproblem@SolutionCounter}{#1-1}%
}

\newcommand{\setbasepath}[1]{\def\tiproblem@basepath{#1}}
\newcommand{\setsolutionsuffix}[1]{\def\tiproblem@solutionsuffix{#1}}

% Define the document headers.
\def\tiproblem@exerciseheader{
    \begin{center}
        \LARGE \tiproblem@titleprefix\ \tiproblem@lecture \\
        \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
        \tiproblem@formatdate
    \end{center}
    \vspace{0.5cm}
}
\def\tiproblem@additionalexerciseheader{
    \begin{center}
        \LARGE \tiproblem@additionalexerciselabel\ \tiproblem@lecture \\
        \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
        \tiproblem@formatdate
    \end{center}
    \vspace{0.5cm}
}
\def\tiproblem@solutionheader{
    \begin{center}
        \LARGE \tiproblem@titleprefix\ \tiproblem@lecture \\
        - \tiproblem@proposedsolutionlabel\ - \\[2mm]
        \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
        \tiproblem@formatdate
    \end{center}
    \vspace{0.5cm}
}

\newcommand{\insertexerciseheader}{
    \TIHeader
    \tiproblem@exerciseheader
}
\newcommand{\insertadditionalexerciseheader}{
    \TIHeader
    \tiproblem@additionalexerciseheader
}
\newcommand{\insertsolutionheader}{
    \TIHeader
    \tiproblem@solutionheader
}

\newcommand{\insertproblem}[2]{
    \def\ExercisePath{\tiproblem@basepath/section#1/#2.tex}
    \begin{problem}
        \IfFileExists{\ExercisePath}{
            \subimport{\tiproblem@basepath/section#1/}{#2.tex}
        }{
            \begin{center}
                \textbf{-- \ExercisePath\ not found --}
            \end{center}
        }
    \end{problem}
    \par
}
\newcommand{\insertsolution}[2]{
    \def\tiproblem@solutionpath{%
        \tiproblem@basepath/section#1/#2\tiproblem@solutionsuffix.tex%
    }
    \begin{solution}
        \IfFileExists{\tiproblem@solutionpath}{
            \subimport{\tiproblem@basepath/section#1/}{%
                #2\tiproblem@solutionsuffix.tex%
            }
        }{
            \begin{center}
                \textbf{-- \tiproblem@solutionpath\ not found --}
            \end{center}
        }
    \end{solution}
    \par
}

% Insert a problem and its solution if available. Only use this for the
% exercise collection documents.
\newcommand{\insertproblemandsolution}[2]{
    \def\ExercisePath{\tiproblem@basepath/section#1/#2.tex}
    \def\tiproblem@solutionpath{%
        \tiproblem@basepath/section#1/#2\tiproblem@solutionsuffix.tex%
    }
    \IfFileExists{\ExercisePath}{
        \textit{{\ExercisePath}:} \\
        \insertproblem{#1}{#2}
        \textit{{\tiproblem@solutionpath}:} \\
        \insertsolution{#1}{#2}
    }{
        \begin{center}
            \textbf{-- \ExercisePath\ not found --}
        \end{center}
    }
    \vspace{-1cm}%
    \noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}%
    \vspace{1cm}
}

\endinput

