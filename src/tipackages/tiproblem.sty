% Copyright (c) 2014 Institute for Theoretical Information Technology,
%                    RWTH Aachen University
%
% This software may be modified and distributed under the terms of the MIT
% license. See the LICENSE file for details.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tiproblem}[2014/10/22 v0.1]

\usepackage{tiinternal}
\usepackage{tidate}
\usepackage{tienv}
\usepackage{timath}

% Define placeholder values for lecture, lecturer, etc. We assume the lecture
% is given in German by default.
\def\tiproblem@lecture{Vorlesung}
\def\tiproblem@lecturer{Dozent}
\def\tiproblem@supervisor{Betreuer}

% Define default text labels.
\def\tiproblem@exerciselabel{Übung}
\def\tiproblem@additionalexerciselabel{Zusatzübung}
\def\tiproblem@additionalexerciselabelsolution{Zusatzübung}
\def\tiproblem@proposedsolutionlabel{Lösungsvorschlag}
\def\tiproblem@problemlabel{Aufgabe}
\def\tiproblem@solutionlabel{Lösung zu Aufgabe}

\def\tiproblem@titleprefix{%
  \thetiproblem@ExerciseCounter.\ \tiproblem@exerciselabel%
}

% Handle package options
\DeclareOption{english}{
  \def\tiproblem@lecture{Lecture}
  \def\tiproblem@lecturer{Lecturer}
  \def\tiproblem@supervisor{Supervisor}

  \def\tiproblem@exerciselabel{Exercise}
  \def\tiproblem@additionalexerciselabel{Review Exercise}
  \def\tiproblem@additionalexerciselabelsolution{Review Exercise}
  \def\tiproblem@proposedsolutionlabel{Proposed Solution}
  \def\tiproblem@problemlabel{Problem}
  \def\tiproblem@solutionlabel{Solution of Problem}

  \def\tiproblem@titleprefix{%
    \tiproblem@exerciselabel\ \thetiproblem@ExerciseCounter%
  }

  \PassOptionsToPackage{\CurrentOption}{tidate}
}

\ProcessOptions\relax

% Initialize defaults.
\def\tiproblem@basepath{.}
\def\tiproblem@searchpath{.}
\def\tiproblem@solutionsuffix{-solution}

% Define the exercise, problem and solution counters. Note that the exercise
% counter is only defined for convenience of error checking. It's never
% actually incremented, but set manually for each exercise.
\newcounter{tiproblem@ExerciseCounter}
\newcounter{tiproblem@ProblemCounter}[section]
\newcounter{tiproblem@SolutionCounter}[section]

% XXX: These shouldn't be used anymore. Use environments from tienv instead.
% Define the labelling scheme for enumerate items.
\renewcommand{\labelenumi}{{\textbf{\alph{enumi})}}}
\renewcommand{\labelenumii}{\textbf{\roman{enumii})}}

% Define new environments.
\newenvironment{problem}{
  \stepcounter{tiproblem@ProblemCounter}
  \textsf{%
    \pagebreak[3]%
    \textbf{\tiproblem@problemlabel\ \thetiproblem@ProblemCounter.}%
  }
}{
  \vspace*{1cm}
}
\newenvironment{solution}{
  \stepcounter{tiproblem@SolutionCounter}
  \textsf{%
    \pagebreak[3]%
    \textbf{%
      \large{\tiproblem@solutionlabel\ \thetiproblem@SolutionCounter}%
    }%
  } \\[2mm]
}{
  \vspace*{1cm}
}

% Define commands to set lecture, lecturer, etc.
\newcommand{\setlecture}[1]{\def\tiproblem@lecture{#1}}
\newcommand{\setlecturer}[1]{\def\tiproblem@lecturer{#1}}
\newcommand{\setsupervisor}[1]{\def\tiproblem@supervisor{#1}}
\newcommand{\setexercisenumber}[1]{\setcounter{tiproblem@ExerciseCounter}{#1}}

% Our counters are zero-based now and incremented before they're used. Hence
% the `#1-1` in the commands below. Note that arithmetic expressions like
% `#1-1` are made possible by the `calc` package.
\newcommand*{\setproblemnumber}[1]{%
  \setcounter{tiproblem@ProblemCounter}{#1-1}%
}
\newcommand*{\setsolutionnumber}[1]{%
  \setcounter{tiproblem@SolutionCounter}{#1-1}%
}

\newcommand{\setbasepath}[1]{\def\tiproblem@basepath{#1}}
\newcommand{\setsearchpath}[1]{\def\tiproblem@searchpath{#1}}
\newcommand{\setsolutionsuffix}[1]{\def\tiproblem@solutionsuffix{#1}}

% Define the document headers.
\def\tiproblem@exerciseheader{
  \parbox{\textwidth}{%
    \centering%
    \LARGE \tiproblem@titleprefix \\
    % FIXME: This line is repeated in every macro.
    \normalsize \tidate@insertdate%
  }%
  \tiinternal@contentvpadding
}
\def\tiproblem@additionalexerciseheader{
  \begin{center}
    \LARGE \tiproblem@additionalexerciselabel\ \tiproblem@lecture \\
    \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
    \tidate@insertdate
  \end{center}
  \vspace{0.5cm}
}
\def\tiproblem@additionalexercisesolutionheader{
  \begin{center}
    \LARGE \tiproblem@additionalexerciselabel\ \tiproblem@lecture \\
    - \tiproblem@proposedsolutionlabel\ - \\[2mm]
    \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
    \tidate@insertdate
  \end{center}
  \vspace{0.5cm}
}
\def\tiproblem@solutionheader{
  \begin{center}
    \LARGE \tiproblem@titleprefix\ \tiproblem@lecture \\
    - \tiproblem@proposedsolutionlabel\ - \\[2mm]
    \normalsize \tiproblem@lecturer, \tiproblem@supervisor \\
    \tidate@insertdate
  \end{center}
  \vspace{0.5cm}
}

\newcommand{\insertexerciseheader}{
  \tiproblem@exerciseheader
}
\newcommand{\insertadditionalexerciseheader}{
  \tiproblem@additionalexerciseheader
}
\newcommand{\insertadditionalexercisesolutionheader}{
  \tiproblem@additionalexercisesolutionheader
}
\newcommand{\insertsolutionheader}{
  \tiproblem@solutionheader
}

\newcommand{\insertproblem}[2]{
  \def\ExercisePath{\tiproblem@basepath/section#1/#2.tex}
  \begin{problem}
    \IfFileExists{\ExercisePath}{
      \subimport{\tiproblem@basepath/section#1/}{#2.tex}
    }{
      \begin{center}
        \textbf{-- \ExercisePath\ not found --}
      \end{center}
    }
  \end{problem}
  \par
}

\newcommand{\insertproblemfile}[1]{
  \begin{problem}
    \subimport{\tiproblem@searchpath/}{#1.tex}
  \end{problem}
  \par
}

\newcommand{\insertsolution}[2]{
  \def\tiproblem@solutionpath{%
    \tiproblem@basepath/section#1/#2\tiproblem@solutionsuffix.tex%
  }
  \begin{solution}
    \IfFileExists{\tiproblem@solutionpath}{
      \subimport{\tiproblem@basepath/section#1/}{%
        #2\tiproblem@solutionsuffix.tex%
      }
    }{
      \begin{center}
        \textbf{-- \tiproblem@solutionpath\ not found --}
      \end{center}
    }
  \end{solution}
  \par
}

\newcommand{\insertsolutionfile}[1]{
  \begin{solution}
    \subimport{\tiproblem@searchpath/}{#1\tiproblem@solutionsuffix.tex}
  \end{solution}
  \par
}

% Insert a problem and its solution if available. Only use this for the
% exercise collection documents.
\newcommand{\insertproblemandsolution}[2]{
  \def\ExercisePath{\tiproblem@basepath/section#1/#2.tex}
  \def\tiproblem@solutionpath{%
    \tiproblem@basepath/section#1/#2\tiproblem@solutionsuffix.tex%
  }
  \IfFileExists{\ExercisePath}{
    \textit{{\ExercisePath}:} \\
    \insertproblem{#1}{#2}
    \textit{{\tiproblem@solutionpath}:} \\
    \insertsolution{#1}{#2}
    \noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}%
    \vspace{1cm}
  }{}
}

\endinput

